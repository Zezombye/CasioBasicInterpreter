<html>
  <meta charset="UTF-8">
  <head>
    <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="js/lz-string.js"></script>
    <script type="text/javascript" src="js/cbi.js"></script>
    <script type="text/javascript" src="js/opcodes.js"></script>
    <script type="text/javascript" src="js/casiotoAscii.js"></script>
    <script type="text/javascript" src="js/g1mtojson.js"></script>
    <link rel="stylesheet" href="css/tabs.css">
    <link href="css/feedback.css" type="text/css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">

    <script>var programExamples = {};</script>

    <script src="../examples/boolTable.json.js"></script>
    <script src="../examples/calendar.json.js"></script>
    <script src="../examples/characterTest.json.js"></script>
    <script src="../examples/city.json.js"></script>
    <script src="../examples/countdown.json.js"></script>
    <script src="../examples/cycloid.json.js"></script>
    <script src="../examples/disp.json.js"></script>
    <script src="../examples/drawSinCos.json.js"></script>
    <script src="../examples/footballPitch.json.js"></script>
    <script src="../examples/getkey.json.js"></script>
    <script src="../examples/helloWorld.json.js"></script>
    <script src="../examples/imc.json.js"></script>
    <script src="../examples/labyrinth.js"></script>
    <script src="../examples/lines.json.js"></script>
    <script src="../examples/list1.json.js"></script>
    <script src="../examples/list2.json.js"></script>
    <script src="../examples/list3.json.js"></script>
    <script src="../examples/lst2tab.json.js"></script>
    <script src="../examples/mazeGenerator.json.js"></script>
    <script src="../examples/menu.json.js"></script>
    <script src="../examples/polygon.json.js"></script>
    <script src="../examples/puissance4.json.js"></script>
    <script src="../examples/randomNum.json.js"></script>
    <script src="../examples/randomDots.json.js"></script>
    <script src="../examples/screenSaver.json.js"></script>
    <script src="../examples/syntaxColorationTest.json.js"></script>
    <script src="../examples/tentacles.json.js"></script>
    <script src="../examples/textMenu.json.js"></script>
    <script src="../examples/worldMap.json.js"></script>
<style>
form {
  margin-block-end: 0;
}

button {
  border-radius: 4px;
  margin: 2px;
}

.buttonVert {
  display: inline-block;
  padding: 2px 4px;
  margin: 3px 2px;
  font-size: 16px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  outline: none;
  color: #fff;
  background-color: #85db85;
  border: none;
  border-radius: 5px;
  box-shadow: 2px 2px #999;
}

.buttonVert:hover {background-color: #52c452}

.buttonVert:active {
  background-color: #52c452;
  box-shadow: 0 0 #666;
  transform: translateY(2px) translateX(2px);
}

.CodeMirror {
  background: transparent;
}

.CodeMirror-linenumber {
  color: blue;
}

#srcCode:not(.readOnly) {
  background-color: white;
}

#srcCode.readOnly {
  background-color: #eee;
}

.error {
  background-color: lightpink;
}

@font-face {
    font-family: 'DejaVuAvecCasio'; /*a name to be used later*/
    src: url('../fonts/DejaVuAvecCasio.ttf'); /*URL to font*/
}

</style>
  </head>
  <body style="background-color: lightsteelblue">
    <div style="text-align: center">
      <div>
        <i><script type="text/javascript">document.write(cbiGetVersion(true));</script></i>
        by <a href="https://www.planet-casio.com/Fr/compte/voir_profil.php?membre=krevo_">Krevo_ </a>
        and <a href="https://www.planet-casio.com/Fr/compte/voir_profil.php?membre=Zezombye">Zezombye </a><br><br>

        <div>
          <canvas id="canvas1" width="508" height="252" style="position: absolute"></canvas>
          <canvas id="canvas2" width="508" height="252" style="position: absolute;"></canvas>
          <canvas id="canvas3" width="508" height="252" style="z-index:-1; position: relative; background-color: white"></canvas>
        </div>

        <div style="display: block; padding-bottom: 4px;" >
         <!-- onclick="calcKeyDown(79); setTimeout(calcKeyUp, 200)" -->
         <button class="buttonVert" onmousedown="calcKeyDown(79)" onmouseup="calcKeyUp()" >F1</button>
         <button class="buttonVert" onmousedown="calcKeyDown(69)" onmouseup="calcKeyUp()" >F2</button>
         <button class="buttonVert" onmousedown="calcKeyDown(59)" onmouseup="calcKeyUp()" >F3</button>
         <button class="buttonVert" onmousedown="calcKeyDown(49)" onmouseup="calcKeyUp()" >F4</button>
         <button class="buttonVert" onmousedown="calcKeyDown(39)" onmouseup="calcKeyUp()" >F5</button>
         <button class="buttonVert" onmousedown="calcKeyDown(29)" onmouseup="calcKeyUp()" >F6</button>
         <button class="buttonVert" onmousedown="calcKeyDown(38)" onmouseup="calcKeyUp()" >←</button>
         <button class="buttonVert" onmousedown="calcKeyDown(28)" onmouseup="calcKeyUp()" >↑</button>
         <button class="buttonVert" onmousedown="calcKeyDown(37)" onmouseup="calcKeyUp()" >↓</button>
         <button class="buttonVert" onmousedown="calcKeyDown(27)" onmouseup="calcKeyUp()" >→</button>
        <br>
         <button class="buttonVert" onmousedown="calcKeyDown(71)" onmouseup="calcKeyUp()" >0</button>
         <button class="buttonVert" onmousedown="calcKeyDown(72)" onmouseup="calcKeyUp()" >1</button>
         <button class="buttonVert" onmousedown="calcKeyDown(62)" onmouseup="calcKeyUp()" >2</button>
         <button class="buttonVert" onmousedown="calcKeyDown(52)" onmouseup="calcKeyUp()" >3</button>
         <button class="buttonVert" onmousedown="calcKeyDown(73)" onmouseup="calcKeyUp()" >4</button>
         <button class="buttonVert" onmousedown="calcKeyDown(63)" onmouseup="calcKeyUp()" >5</button>
         <button class="buttonVert" onmousedown="calcKeyDown(53)" onmouseup="calcKeyUp()" >6</button>
         <button class="buttonVert" onmousedown="calcKeyDown(74)" onmouseup="calcKeyUp()" >7</button>
         <button class="buttonVert" onmousedown="calcKeyDown(64)" onmouseup="calcKeyUp()" >8</button>
         <button class="buttonVert" onmousedown="calcKeyDown(54)" onmouseup="calcKeyUp()" >9</button>
        <br>
         <button class="buttonVert" onmousedown="calcKeyDown(61)" onmouseup="calcKeyUp()" >.</button>
         <button class="buttonVert" onmousedown="calcKeyDown(42)" onmouseup="calcKeyUp()" >+</button>
         <button class="buttonVert" onmousedown="calcKeyDown(32)" onmouseup="calcKeyUp()" >-</button>
         <button class="buttonVert" onmousedown="calcKeyDown(43)" onmouseup="calcKeyUp()" >×</button>
         <button class="buttonVert" onmousedown="calcKeyDown(33)" onmouseup="calcKeyUp()" >÷</button>
         <button class="buttonVert" onmousedown="calcKeyDown(44)" onmouseup="calcKeyUp()" >DEL</button>
         <button class="buttonVert" onmousedown="calcKeyDown(31)" onmouseup="calcKeyUp()" >Exe</button>
        </div>
         <form action="">
           <input type="radio" id="black_white" name="colorScheme" onchange="chooseColorScheme('black&white');" >Black/White
           <input type="radio" id="blue_green" name="colorScheme" onchange="chooseColorScheme('blue&green');" >Blue/Green
           <input type="radio" id="multicolor" name="colorScheme" onchange="chooseColorScheme('multicolor');" checked="checked">Multicolor
         </form>
         <form action="">
           <input type="radio" id="lowRes" name="res" onchange="selectResolution('low');" >LowRes
           <input type="radio" id="hiRes" name="res" onchange="selectResolution('hi');" checked="checked">HiRes
         </form>
         <button class="" onclick="swap();">G ↔ T</button>
       <br><br>
        <button onclick="executeCode();"><i class="fa fa-play" aria-hidden="true"></i>  Execute</button>
        <button onclick="stopCodeExecution()"><i class="fa fa-stop" aria-hidden="true"></i> STOP</button>
        <!-- Hidden features for experts/developpers -->
        <span id="devButtons" >
          <button onclick="displayStatusMsg('Log DEBUG is '+(debugToggle()?'On':'Off'))"><i class="fa fa-bug" aria-hidden="true"></i> Log debug On/Off</button>
          <button onclick="displayStatusMsg('Increasing speed. Timeout is now '+adjustTimeout(-1)+' ms')">Speed <i class="fa fa-plus" aria-hidden="true"></i></button>
          <button onclick="displayStatusMsg('Decreasing speed. Timeout is now '+adjustTimeout(1)+' ms')">Speed <i class="fa fa-minus" aria-hidden="true"></i></button>
          <button id="feedback"><i class="fa fa-envelope-o"></i> Send bug report</button>
          <button id="share"><i class="fa fa-share-alt" aria-hidden="true"></i> Share</button>
        </span>
        <div id="statusbar" style="display: none"><span id="status" style="color: red"></span></div>
        <div style="text-align:center; margin: 0px; display: inline-block; width: 75%;">
          <div id="editorTabs">
          </div>
          <br>
          <div id="srcCode" style="text-align: left; display: inline-block; width: 100%; height:300px;"><!-- Monaco editor --></div>
        </div>

        <div style="display: none">
        Load raw content from URL : <input type="text" size="60" id="urlLoader">
        <button onclick="loadFromUrl()">Load</button>
        </div>
        <br>
        <button onclick="insertSpecialChar('→');">→</button>
        <button onclick="insertSpecialChar('⇒');">⇒</button>
        <button onclick="insertSpecialChar('≠');">≠</button>
        <button onclick="insertSpecialChar('≥');">≥</button>
        <button onclick="insertSpecialChar('≤');">≤</button>
        <button onclick="insertSpecialChar('◢');">◢</button>
        <button onclick="insertSpecialChar('r');">r</button>
        <button onclick="insertSpecialChar('θ');">θ</button>
        <button onclick="insertSpecialChar('π');">π</button>
        <br>
 List of <a href="availablefunctions.html">currently implemented functions</a> (and list of <a href="knownproblems.html">known problems</a>)<br>
 Sample programs :<br>
        <button onclick="loadProg('helloWorld');">Hello World !</button>
        <button onclick="loadProg('cycloid');">Cycloïd</button>
        <button onclick="loadProg('drawSinCos');">Draw sin/cos</button>
        <button onclick="loadProg('countdown');">5,4,3,...</button>
        <button onclick="loadProg('screenSaver');">Screen saver</button>
        <button onclick="loadProg('lines');">Lines</button>
        <button onclick="loadProg('randomDots');">Random dots</button>
        <button onclick="loadProg('randomNum');">Random num</button>
        <button onclick="loadProg('imc');">IMC</button>
        <br>
        <button onclick="loadProg('mazeGenerator');">Maze generator</button>
        <button onclick="loadProg('calendar');">Calendrier</button>
        <button onclick="loadProg('polygon');">Polygon</button>
        <button onclick="loadProg('disp');">Disp ◢</button>
        <button onclick="loadProg('getkey');">GetKey</button>
        <button onclick="loadProg('textMenu');">Text Menu</button>
        <button onclick="loadProg('city');">City</button>
        <button onclick="loadProg('labyrinth');">Labyrinthe</button>
        <button onclick="loadProg('tentacles');">Tentacules</button>
        <button onclick="loadProg('puissance4');">Puissance 4</button>
        <br>
        <button onclick="loadProg('worldMap');">World map</button>
        <button onclick="loadProg('footballPitch');">Football pitch</button>
        <button onclick="loadProg('boolTable');">Bool. table</button>
        <button onclick="loadProg('list1');">List 1</button>
        <button onclick="loadProg('list2');">List 2</button>
        <button onclick="loadProg('list3');">List 3</button>
        <button onclick="loadProg('lst2tab');">Lst2Tab</button>
        <button onclick="loadProg('menu');">Menu</button>
        <br>
        <button onclick="loadProg('syntaxColorationTest');">Syntax coloration test</button>
        <button onclick="loadProg('characterTest');">Character test</button>
        <br><br>
      </div>
    </div>

<div class="feedback-box">
  <div class="content"> <a class="close" href="#"><i class="fa fa-times"></i></a>
    <div class="confirm">
      <h1><strong>BOOOM!</strong> <span>We'll get right on that for ya</span></h1>
    </div>
    <header>Help me to improve the <i>Casio Basic Web Interpreter</i> !</header>
    <section>
      <form id="bugReportForm" action="/">
      <input type="hidden" id="code" name="code">
      <div>
        <label for="name">Last status</label>
        <span style="float: right;" title="Your current program is attached to this message"><i class="fa fa-paperclip" aria-hidden="true"></i> <span id="codesize">xx</span> bytes</span>
      </div>
      <input type="text" id="error" name="error"><br><br>
      <label for="name">Name or Pseudo</label><br>
      <input type="text" name="name"><br><br>
      <label for="email">Email (if you want an answer)</label><br>
      <input type="text" name="email"><br><br>
      <label for="feedback">Message (english or french accepted)</label><br>
      <textarea id="feedbackArea" name="feedback"></textarea>
      <button id='submit'>Send bug report</button>
      </form>
    </section>
  </div>
</div>

<script>
(function($){
  var words = ["Boom!" , "Whammy!", "Booya!" , "Holler!", "Broskee!" , "All Good!" , "Right on!"];
  var feedback = $(".feedback-box");

  //Feedback Toggle
	$("#feedback").on("click" , function(){
		feedback.addClass("show");
	});

  //Close Trigger
	$(".close").on("click" , function(){
    feedback.removeClass("show");
    setTimeout(function(){
      feedback.removeClass("show-confirm").find("textarea").val('');
      console.log("reset")
    }, 1000);
	});

//Submit
  $("#submit").on("click" , function(event){
    event.preventDefault();
    if (!feedback.find("textarea").val() ) {
  //     if( !$("textarea").val() ) {
       feedback.addClass("error");
       setTimeout(function(){
         feedback.removeClass("error");
       }, 500)
    } else {
      console.log("Send feedback !");
      console.log($('#bugReportForm').serialize());
      $.post( "bugreport.php", $( "#bugReportForm" ).serialize() );
      feedback.addClass("show-confirm");
      var randomWord = words[Math.floor(Math.random() * words.length)];
      $(".feedback-box h1 strong").text(randomWord);

      setTimeout(function(){
         feedback.removeClass("show").find("textarea").val('').delay(1000);
      },2000);

       setTimeout(function(){
         feedback.removeClass("show-confirm");
      },2200);
    }
  })
})(jQuery);
</script>

<script src="../lib/monaco-editor/min/vs/loader.js"></script>
<script src="js/loadMonaco.js"></script>

    <script type="text/javascript">

      var tabToModelMap = {};
      var tabEditorStates = {};
      var currentSelectedTab = null;

      function loadFromUrl() {
        var urlToLoad = document.getElementById("urlLoader").value;

        var request = new XMLHttpRequest();
        request.open('GET', urlToLoad, true);

        request.onreadystatechange = function() {
          if (this.readyState === 4) {
            if (this.status >= 200 && this.status < 400) {
              // Success!
              var srcCode = this.responseText;
              document.getElementById("srcCode").value = srcCode;
              executeCode();
            } else {
              document.getElementById("status").innerHTML = 'Unable to load content from Url !';
            }
          }
        };

        request.send();
        request = null;
      }

      function insertSpecialChar(specialChar) {
        /*myCodeMirror.replaceSelection(specialChar);
        myCodeMirror.focus();*/
        //TODO
      }

      function addTab(tabName, content) {
        tabToModelMap[tabName] = monaco.editor.createModel(content, "basic-casio");
        tab = document.createElement("span");
        tab.className = "tab";
        tab.innerText = tabName;
        tab.onclick = function() {
          selectTab(tabName);
        }
        document.getElementById("editorTabs").appendChild(tab);
      }

      function selectTab(tabName) {
        if (currentSelectedTab !== null) {
          tabEditorStates[currentSelectedTab] = editor.saveViewState();
        }
        currentSelectedTab = tabName;
        for (var tab of document.getElementsByClassName("tab")) {
          if (tab.innerText === tabName) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        }

        editor.setModel(tabToModelMap[tabName]);
        if (tabName in tabEditorStates) {
          editor.restoreViewState(tabEditorStates[tabName]);
        }
        editor.focus();
      }

      async function loadProg(sourceName) {
        stopCodeExecution();
        monaco.editor.getModels().forEach(model => model.dispose());
        document.querySelectorAll('.tab').forEach(e => e.remove());
        tabEditorStates = {};
        tabToModelMap = {};
        currentSelectedTab = null;
        var srcCode = programExamples[sourceName];
        if (typeof srcCode === "string") {
          srcCode = g1mToJson(srcCode);
        }
        for (var part of srcCode) {
          if (part.type === "program") {
            part.content = "#Program name: "+part.name+"\n#Password: <no password>\n\n"+part.content;
            addTab(part.name, part.content);
          }
        }
        selectTab(srcCode[0].name);
        // document.getElementById("srcCode").value = srcCode;
        //window.editor.setValue(JSON.stringify(srcCode));
        //window.editor.setScrollPosition({scrollTop: 0})
        executeCode();
      }

      function loadProgFromSrc(srcCode) {
        stopCodeExecution();
        window.editor.setValue(srcCode);
        window.editor.setScrollPosition({scrollTop: 0})
        executeCode();
      }

      function displayStatusMsg(statusMsg, detailLong) {
        document.getElementById("error").value = statusMsg;
        document.getElementById("feedbackArea").value = 'Full error was : \n' + detailLong;
        $("#statusbar").show();
        document.getElementById("status").innerHTML = statusMsg + (detailLong ? (' <span title="' + detailLong + '"><i class="fa fa-question-circle" aria-hidden="true"></i></span>') : '');
      }

      function removeErrorLines() {
          /*var lineCount = myCodeMirror.getDoc().lineCount();
          for (var i = 0; i< lineCount; i++) {
              myCodeMirror.getDoc().removeLineClass(i, "background", "error");
          }*/
          //TODO, useful?
      }

      function executeCode() {
        removeErrorLines();
        var srcCode = []
        for (var model of monaco.editor.getModels()) {
          tabContent = model.getValue().trim();
          if (tabContent.startsWith("#Program name: ")) {
            programName = tabContent.substring(0, tabContent.indexOf("\n")).substring("#Program name: ".length);
            srcCode.push({"type": "program", "name": programName, "content": tabContent});
          }
        }
        $("#code").val(srcCode);
        $("#codesize").text(srcCode.length);
        document.getElementById("canvas1").focus();
        document.getElementById("srcCode").className = 'readOnly';
        //myCodeMirror.setOption("readOnly", "nocursor");
        //myCodeMirror.setOption("className", "readOnly");
        document.getElementById("error").value = '';
        document.getElementById("status").innerHTML = '';
        $("#statusbar").hide();
        if (idTimerMain == 0) {
          jsccRun(srcCode, function(errorCode, msg, programs, detail, lineNumber) {
              if (errorCode > 0) {
                  if (detail && detail.indexOf("\n") != -1) {
                    displayStatusMsg(msg, detail);
                  } else {
                    displayStatusMsg(msg + (detail ? detail : ""));
                  }
                  if (lineNumber) {
                    //myCodeMirror.getDoc().addLineClass(lineNumber - 1, "background", "error");
                    jumpToLine(lineNumber);
                  }
              }
              //document.getElementById("srcCode").disabled = false;
              document.getElementById("srcCode").className = '';
              //myCodeMirror.setOption("readOnly", false);
          });
        }
      }

      function stopCodeExecution() {
        finish(EXIT_STOPPED, "Stopped on user request.");
      }

      function jumpToLine(i) {
        /*var t = myCodeMirror.charCoords({line: i, ch: 0}, "local").top;
        var middleHeight = myCodeMirror.getScrollerElement().offsetHeight / 2;
        myCodeMirror.scrollTo(null, t - middleHeight - 5);*/
        //TODO, redo with marks on sidebar
      }

      window.onload = function() {
          var url_string = window.location.href
          var url = new URL(url_string);
          var compressedSrcCode = url.searchParams.get("src");
          if (compressedSrcCode) {
            var decompressedSrcCode = LZString.decompressFromEncodedURIComponent(compressedSrcCode);
            loadProgFromSrc(decompressedSrcCode);
          } else {
            loadProg("puissance4");
          }
      }

$("#share").on("click" , function(event){
    event.preventDefault();
    var srcCode = window.editor.getValue();
    var compressed = LZString.compressToEncodedURIComponent(srcCode);
    var url = window.location.protocol+'//'+window.location.hostname+window.location.pathname;
    displayStatusMsg('<input id="urlToCopy" value="'+url+'?src='+compressed+'" size="80" /> <button id="copy"><i class="fa fa-files-o" aria-hidden="true"></i> Copy Url</button>');
    document.querySelector("#copy").addEventListener("click", function(event) {
        var copyText = document.querySelector("#urlToCopy");
        copyText.select();
        document.execCommand("copy");
    });
});

// Replace non-visible caracters by visible ones.
$("#srcCode").bind('paste drop', function(e) {
    var elem = $(this);

    setTimeout(function() {
        // gets the copied text after a specified time (100 milliseconds)
        //var savedCursorPos = myCodeMirror.getCursor();
        var text = window.editor.getValue();
        text = text.replace(/(\uE015)/g, 'r'); // Replace "rho" (U+E015 used in BIDE) by "r"
        text = text.replace(/(\uE016)/g, 'i'); // Replace "i" (imaginary unit of complex number) (U+E016 used in BIDE) by "i"
        text = text.replace(/(\uE063)/g, '/'); // Replace "slash" (U+E063 used in BIDE) by "/"
        window.editor.setValue(text);
        window.editor.setScrollPosition({scrollTop: 0})
        //myCodeMirror.setCursor(savedCursorPos); // Replace cursor where it was (because setting the value of the content place cursor at beginning)
    }, 100);
});

      //executeCode();
    </script>

  </body>
</html>
